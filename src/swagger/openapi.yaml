openapi: 3.0.3
info:
  title: Kubernetes Namespace Provisioner API
  description: |
    TypeScript implementation of the Eclipse Che server's Kubernetes namespace provisioning API.
    
    This API provides endpoints for provisioning and managing Kubernetes namespaces where 
    authenticated users can create workspaces.
    
    ## Original Java Implementation
    This API is based on the Eclipse Che server endpoint:
    - Java Class: `org.eclipse.che.workspace.infrastructure.kubernetes.api.server.KubernetesNamespaceService`
    - Endpoint: `POST /kubernetes/namespace/provision`
    
    ## Authentication
    The API supports two authentication methods:
    1. **Bearer Token**: Format `userid:username` (e.g., `Bearer user123:johndoe`)
    2. **Basic Auth**: Username and userid as password (e.g., `johndoe:user123`)
    
    ## Features
    - ✅ Provision Kubernetes namespaces with configurable name templates
    - ✅ List all managed namespaces
    - ✅ Automatic namespace creation if not exists
    - ✅ Namespace metadata with status and attributes
    
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com
  license:
    name: Eclipse Public License 2.0
    url: https://www.eclipse.org/legal/epl-2.0/

servers:
  - url: http://localhost:3000
    description: Development server
  - url: https://api.example.com
    description: Production server

tags:
  - name: kubernetes-namespace
    description: Kubernetes namespace provisioning and management operations
  - name: factory
    description: Factory creation and resolution operations
  - name: oauth
    description: OAuth authentication and token management operations
  - name: scm
    description: SCM (Source Control Management) file resolution operations
  - name: health
    description: Health check and monitoring endpoints

paths:
  /health:
    get:
      tags:
        - health
      summary: Health check
      description: Returns the health status of the API service
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: ok
                timestamp: '2025-11-13T10:30:00.000Z'

  /kubernetes/namespace:
    get:
      tags:
        - kubernetes-namespace
      summary: List namespaces
      description: |
        Get k8s namespaces where user is able to create workspaces. 
        This operation can be performed only by authorized user.
        
        **Note**: This is a beta feature that may be significantly changed.
      operationId: listNamespaces
      security:
        - BearerAuth: []
        - BasicAuth: []
      responses:
        '200':
          description: The namespaces successfully fetched
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/KubernetesNamespaceMeta'
              example:
                - name: che-johndoe
                  attributes:
                    phase: Active
                    default: 'true'
                - name: che-janedoe
                  attributes:
                    phase: Active
                    default: 'false'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /kubernetes/namespace/provision:
    post:
      tags:
        - kubernetes-namespace
      summary: Provision namespace
      description: |
        Provision k8s namespace where user is able to create workspaces. 
        This operation can be performed only by an authorized user.
        
        The namespace name is generated based on a configurable template. 
        By default, it uses the pattern `che-<username>` where `<username>` 
        is replaced with the authenticated user's username.
        
        If the namespace already exists, it returns the existing namespace metadata.
        
        **Note**: This is a beta feature that may be significantly changed.
        
        ## How it works
        1. Extracts user information from authentication context
        2. Evaluates namespace name using the configured template
        3. Creates namespace in Kubernetes if it doesn't exist
        4. Configures namespace with appropriate labels and annotations
        5. Returns namespace metadata including name and attributes
        
        ## Namespace Attributes
        - `phase`: Current namespace status (Active, Terminating, etc.)
        - `default`: Whether this is the user's default namespace (true/false)
      operationId: provisionNamespace
      security:
        - BearerAuth: []
        - BasicAuth: []
      responses:
        '200':
          description: The namespace successfully provisioned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KubernetesNamespaceMeta'
              example:
                name: che-johndoe
                attributes:
                  phase: Active
                  default: 'true'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /factory/resolver:
    post:
      tags:
        - factory
      summary: Resolve factory from parameters
      description: |
        Create factory by providing map of parameters. Returns JSON with factory information.
        
        This endpoint resolves a factory from various sources like:
        - Raw devfile URLs
        - Git repository URLs
        - SCM provider URLs (GitHub, GitLab, Bitbucket, etc.)
        
        The resolver automatically detects the source type and creates appropriate factory.
        
        **Note**: This is a beta feature that may be significantly changed.
        
        ## How it works
        1. Accepts parameters (primarily a URL)
        2. Finds appropriate resolver for the parameters
        3. Fetches devfile or repository information
        4. Creates factory with devfile v2 structure
        5. Returns factory metadata with links
        
        ## Validation
        Use `validate=true` query parameter to validate the factory according to acceptance rules.
      operationId: resolveFactory
      security:
        - BearerAuth: []
        - BasicAuth: []
      parameters:
        - name: validate
          in: query
          description: Whether or not to validate values like it is done when accepting a Factory
          required: false
          schema:
            type: boolean
            default: false
      requestBody:
        required: true
        description: Parameters provided to create factory (typically containing URL)
        content:
          application/json:
            schema:
              type: object
              properties:
                url:
                  type: string
                  description: |
                    URL pointing to a devfile. Must end with a valid devfile filename:
                    - devfile.yaml
                    - .devfile.yaml
                  example: https://raw.githubusercontent.com/user/repo/main/devfile.yaml
              additionalProperties:
                type: string
            examples:
              devfileYaml:
                value:
                  url: https://raw.githubusercontent.com/eclipse-che/che-server/main/devfile.yaml
              hiddenDevfileYaml:
                value:
                  url: https://raw.githubusercontent.com/user/repo/main/.devfile.yaml
      responses:
        '200':
          description: Factory successfully built from parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FactoryMeta'
              examples:
                devfileV2Factory:
                  value:
                    v: '4.0'
                    name: che-server
                    source: devfile.yaml
                    devfile:
                      schemaVersion: '2.1.0'
                      metadata:
                        name: che-server
                    links:
                      - rel: self
                        href: /factory/resolver?url=https://example.com/devfile.yaml
        '400':
          description: Missed required parameters or failed to validate factory
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                noParameters:
                  value:
                    error: Bad Request
                    message: Factory build parameters required
                notResolvable:
                  value:
                    error: Bad Request
                    message: Cannot build factory with any of the provided parameters. Please check parameters correctness, and resend query.
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /factory/token/refresh:
    post:
      tags:
        - factory
      summary: Refresh factory OAuth token
      description: |
        Validate the factory related OAuth token and update/create it if needed.
        
        This endpoint checks and refreshes personal access tokens for SCM providers
        used to access factory sources (GitHub, GitLab, Bitbucket, etc.).
        
        The token refresh process:
        1. Parses the factory URL to determine SCM provider
        2. Checks if authorization was previously rejected
        3. If not rejected, validates or refreshes the token
        4. Stores updated token securely
        
        **Note**: Set `CHE_FORCE_REFRESH_PERSONAL_ACCESS_TOKEN=true` environment variable
        to force token refresh even if existing token is valid.
      operationId: refreshFactoryToken
      security:
        - BearerAuth: []
        - BasicAuth: []
      parameters:
        - name: url
          in: query
          description: Factory URL for which to refresh the OAuth token
          required: true
          schema:
            type: string
          example: https://github.com/user/repo
      responses:
        '200':
          description: The factory related OAuth token is valid or has been updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Token refreshed successfully
        '400':
          description: Factory URL is required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Bad Request
                message: Factory url required
        '401':
          description: Failed to update the factory related OAuth token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Unauthorized
                message: Failed to update the factory related OAuth token
        '500':
          $ref: '#/components/responses/InternalServerError'

  /oauth:
    get:
      tags:
        - oauth
      summary: Get registered OAuth authenticators
      description: |
        Gets list of installed OAuth authenticators.
        
        Returns information about all configured OAuth providers (GitHub, GitLab, Bitbucket, etc.)
        that can be used for authentication.
        
        Each authenticator descriptor contains:
        - Provider name
        - Authentication endpoint URL
        - Links to authentication and token operations
      operationId: getRegisteredAuthenticators
      security:
        - BearerAuth: []
        - BasicAuth: []
      responses:
        '200':
          description: List of registered OAuth authenticators
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/OAuthAuthenticatorDescriptor'
              example:
                - name: github
                  endpointUrl: https://github.com/login/oauth/authorize
                  links:
                    - rel: authenticate
                      href: /oauth/authenticate?oauth_provider=github
                    - rel: token
                      href: /oauth/token?oauth_provider=github
                - name: gitlab
                  endpointUrl: https://gitlab.com/oauth/authorize
                  links:
                    - rel: authenticate
                      href: /oauth/authenticate?oauth_provider=gitlab
                    - rel: token
                      href: /oauth/token?oauth_provider=gitlab
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /oauth/token:
    get:
      tags:
        - oauth
      summary: Get OAuth token
      description: |
        Gets OAuth token for the authenticated user and specified provider.
        
        If no token exists, this endpoint will generate a new token (in demo mode)
        or trigger the OAuth flow (in production).
        
        The token can be used to access SCM provider APIs on behalf of the user.
      operationId: getOAuthToken
      security:
        - BearerAuth: []
        - BasicAuth: []
      parameters:
        - name: oauth_provider
          in: query
          description: OAuth provider name (e.g., github, gitlab, bitbucket)
          required: true
          schema:
            type: string
            enum: [github, gitlab, bitbucket, azure-devops]
          example: github
      responses:
        '200':
          description: OAuth token successfully retrieved or created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthToken'
              example:
                token: gho_1234567890abcdefghijklmnopqrstuvwxyz
                scope: repo user write:public_key
        '400':
          description: OAuth provider parameter is required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Bad Request
                message: OAuth provider is required
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: OAuth provider not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Not Found
                message: OAuth provider not found
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    delete:
      tags:
        - oauth
      summary: Invalidate OAuth token
      description: |
        Invalidates (deletes) OAuth token for the authenticated user and specified provider.
        
        After invalidation, the user will need to re-authenticate with the OAuth provider
        to obtain a new token.
        
        This is useful for:
        - Revoking access to SCM providers
        - Security purposes (token rotation)
        - Testing OAuth flows
      operationId: invalidateOAuthToken
      security:
        - BearerAuth: []
        - BasicAuth: []
      parameters:
        - name: oauth_provider
          in: query
          description: OAuth provider name (e.g., github, gitlab, bitbucket)
          required: true
          schema:
            type: string
            enum: [github, gitlab, bitbucket, azure-devops]
          example: github
      responses:
        '204':
          description: OAuth token successfully invalidated (no content)
        '400':
          description: OAuth provider parameter is required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Bad Request
                message: OAuth provider is required
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: OAuth token not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Not Found
                message: OAuth token not found
        '500':
          $ref: '#/components/responses/InternalServerError'

  /scm/resolve:
    get:
      tags:
        - scm
      summary: Resolve file content from SCM repository
      description: |
        Get file content by specific repository URL and filename.
        
        This endpoint resolves and retrieves file content from various SCM providers:
        - GitHub
        - GitLab
        - Bitbucket
        - Any Git-based repository with public access
        
        The resolver automatically detects the SCM provider based on the repository URL
        and uses the appropriate API or raw content URL to fetch the file.
        
        **Common use cases**:
        - Fetching devfile.yaml from repositories
        - Reading configuration files
        - Accessing repository metadata files
        
        **Note**: For private repositories, ensure proper OAuth tokens are configured.
      operationId: resolveScmFile
      security:
        - BearerAuth: []
        - BasicAuth: []
      parameters:
        - name: repository
          in: query
          description: Repository URL (GitHub, GitLab, Bitbucket, or any Git repository)
          required: true
          schema:
            type: string
          examples:
            github:
              value: https://github.com/eclipse-che/che-server
              summary: GitHub repository
            gitlab:
              value: https://gitlab.com/user/project
              summary: GitLab repository
            raw:
              value: https://raw.githubusercontent.com/eclipse/che/main/devfile.yaml
              summary: Direct raw URL
        - name: file
          in: query
          description: File path or name within the repository
          required: true
          schema:
            type: string
          examples:
            devfile:
              value: devfile.yaml
              summary: Devfile in root
            nested:
              value: .devfile/devfile.yaml
              summary: Nested devfile
            readme:
              value: README.md
              summary: README file
      responses:
        '200':
          description: File content successfully retrieved
          content:
            text/plain:
              schema:
                type: string
              example: |
                schemaVersion: 2.1.0
                metadata:
                  name: che-server
                components:
                  - name: tools
                    container:
                      image: quay.io/devfile/universal-developer-image:latest
        '400':
          description: Missing required parameters or invalid repository URL
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingRepository:
                  value:
                    error: Bad Request
                    message: Repository parameter is required
                missingFile:
                  value:
                    error: Bad Request
                    message: File parameter is required
                noResolver:
                  value:
                    error: Bad Request
                    message: Cannot find suitable file resolver for the provided URL
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Requested file not found in repository
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Not Found
                message: Requested file not found in repository
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  schemas:
    HealthResponse:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          description: Health status of the service
          enum: [ok, degraded, down]
          example: ok
        timestamp:
          type: string
          format: date-time
          description: Current server timestamp
          example: '2025-11-13T10:30:00.000Z'

    KubernetesNamespaceMeta:
      type: object
      required:
        - name
        - attributes
      properties:
        name:
          type: string
          description: |
            The name of the namespace.
            
            Value may be not a name of existing namespace, but predicted name 
            with placeholders inside, like `<workspaceid>`.
          example: che-johndoe
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
          minLength: 1
          maxLength: 63
        attributes:
          type: object
          description: |
            Namespace attributes, which may contain additional info about the namespace.
            
            Common attributes:
            - `default`: "true" or "false" - shows if k8s namespace is configured as default
            - `phase`: "Active" or "Terminating" - current namespace status
          additionalProperties:
            type: string
          example:
            phase: Active
            default: 'true'

    FactoryMeta:
      type: object
      required:
        - v
      properties:
        v:
          type: string
          description: Factory version
          example: '4.0'
        name:
          type: string
          description: Factory name
          example: my-workspace
        id:
          type: string
          description: Factory ID (set by server)
          example: factory123
        source:
          type: string
          description: |
            Indicates filename in repository from which the factory was created 
            (for example, devfile.yaml) or just contains 'repo' value if factory 
            was created from bare repository. For custom raw URLs (pastebin, gist etc) 
            value is null
          example: devfile.yaml
        devfile:
          type: object
          description: |
            Devfile v2 as a generic object. Since che-server doesn't know the structure 
            of Devfile v2, we use a generic object type.
          additionalProperties: true
          example:
            schemaVersion: '2.1.0'
            metadata:
              name: my-project
        scm_info:
          type: object
          description: SCM (Source Control Management) information
          properties:
            cloneUrl:
              type: string
              example: https://github.com/user/repo.git
            branch:
              type: string
              example: main
            scmProviderName:
              type: string
              example: github
            scmProviderUrl:
              type: string
              example: https://github.com
        creator:
          type: object
          description: Factory creator information
          properties:
            userId:
              type: string
              example: user123
            userName:
              type: string
              example: johndoe
            created:
              type: integer
              format: int64
              description: Creation timestamp
              example: 1699876543000
        policies:
          type: object
          description: Factory policies
          properties:
            referer:
              type: string
            since:
              type: integer
              format: int64
            until:
              type: integer
              format: int64
        ide:
          type: object
          description: IDE configuration
          properties:
            onAppClosed:
              type: string
            onAppLoaded:
              type: string
            onProjectsLoaded:
              type: string
        links:
          type: array
          description: HAL links for factory operations
          items:
            type: object
            properties:
              rel:
                type: string
                example: self
              href:
                type: string
                example: /factory/resolver?url=https://example.com/devfile.yaml
              method:
                type: string
                example: GET

    OAuthToken:
      type: object
      required:
        - token
      properties:
        token:
          type: string
          description: OAuth access token
          example: gho_1234567890abcdefghijklmnopqrstuvwxyz
        scope:
          type: string
          description: OAuth scope (space-separated list of permissions)
          example: repo user write:public_key

    OAuthAuthenticatorDescriptor:
      type: object
      required:
        - name
        - endpointUrl
      properties:
        name:
          type: string
          description: Name of the OAuth provider
          enum: [github, gitlab, bitbucket, azure-devops]
          example: github
        endpointUrl:
          type: string
          description: OAuth authorization endpoint URL
          example: https://github.com/login/oauth/authorize
        links:
          type: array
          description: HAL links for OAuth operations
          items:
            type: object
            properties:
              rel:
                type: string
                example: authenticate
              href:
                type: string
                example: /oauth/authenticate?oauth_provider=github

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error type or category
          example: Unauthorized
        message:
          type: string
          description: Detailed error message
          example: Authorization header is required
        details:
          type: string
          description: Additional error details (only in development mode)
          example: Missing Authorization header in request

    ExtendedError:
      allOf:
        - $ref: '#/components/schemas/ErrorResponse'
        - type: object
          properties:
            stack:
              type: string
              description: Stack trace (only in development mode)
              example: 'Error: Not able to find namespace\n    at NamespaceProvisioner.provision...'

  responses:
    Unauthorized:
      description: Unauthorized - Authentication required or invalid credentials
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            missingAuth:
              value:
                error: Unauthorized
                message: Authorization header is required
            invalidAuth:
              value:
                error: Unauthorized
                message: Invalid authorization credentials

    InternalServerError:
      description: Internal server error occurred
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ExtendedError'
          examples:
            namespaceNotFound:
              value:
                error: Internal Server Error
                message: Not able to find namespace che-johndoe
            kubernetesError:
              value:
                error: Internal Server Error
                message: Failed to create namespace
                details: Kubernetes API error - Forbidden

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: userid:username
      description: |
        Bearer token authentication using the format `userid:username`.
        
        Example: `Authorization: Bearer user123:johndoe`
        
        In production, this should be replaced with proper JWT tokens.

    BasicAuth:
      type: http
      scheme: basic
      description: |
        Basic authentication using username and userid.
        
        - Username: user's username (e.g., `johndoe`)
        - Password: user's ID (e.g., `user123`)
        
        Example: `Authorization: Basic am9obmRvZTp1c2VyMTIz` (base64 of `johndoe:user123`)

security:
  - BearerAuth: []
  - BasicAuth: []

