# Copyright (c) 2025 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# NOTE: This docker-compose.yml is OPTIONAL and provided for convenience.
# The recommended way to build and run is using Docker directly:
#   build/build.sh
#   docker run -p 8080:8080 che-server
# Or see build/dockerfiles/Dockerfile for manual build instructions.

services:
  che-server:
    build:
      context: ../..
      dockerfile: build/dockerfiles/Dockerfile
    ports:
      - "8080:8080"
    environment:
      - NODE_ENV=production
      - PORT=8080
      - HOST=0.0.0.0
      - NAMESPACE_TEMPLATE=che-<username>
      - CHE_FACTORY_DEFAULT_DEVFILE_FILENAMES=devfile.yaml,.devfile.yaml
    volumes:
      # Mount kubeconfig for Kubernetes access
      - ~/.kube/config:/home/user/.kube/config:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
