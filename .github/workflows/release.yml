#
# Copyright (c) 2025 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#

name: Release Che Server Next

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'The version that is going to be released. Should be in format X.Y.Z (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      forceRecreateTags:
        description: 'If true, tags will be recreated. Use with caution'
        required: false
        default: 'false'

env:
  IMAGE: docker.io/olexii4dockerid/che-server

jobs:

  tag-release:
    runs-on: ubuntu-22.04
    steps:
      -
        name: "Checkout Che Server Next source code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      -
        name: "Setup Node"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      -
        name: "Check existing tags"
        run: |
          set +e
          RECREATE_TAGS=${{ github.event.inputs.forceRecreateTags }}
          VERSION=${{ github.event.inputs.version }}
          EXISTING_TAG=$(git ls-remote --exit-code origin refs/tags/${VERSION})
          if [[ -n ${EXISTING_TAG} ]]; then
            if [[ ${RECREATE_TAGS} == "true" ]]; then
              echo "[INFO] Removing tag for ${VERSION} version. New tag will be recreated during release."
              git push origin :$VERSION
            else
              echo "[ERROR] Cannot proceed with release - tag ${EXISTING_TAG} already exists."
              exit 1
            fi
          else
            echo "[INFO] No existing tags detected for $VERSION"
          fi
      -
        name: "Tag release"
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git config --global pull.rebase true
          
          VERSION=${{ github.event.inputs.version }}
          
          echo "[INFO] Creating and pushing tag ${VERSION}"
          git tag -a ${VERSION} -m "Release ${VERSION}"
          git push origin ${VERSION}
          
          echo "[INFO] Tag ${VERSION} created and pushed successfully"

  build-images:
    runs-on: ubuntu-22.04
    needs: tag-release
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
    outputs:
      amd64: ${{ steps.result.outputs.amd64 }}
      arm64: ${{ steps.result.outputs.arm64 }}
    steps:
      -
        name: "Checkout Che Server Next source code"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}
      -
        name: "Set up QEMU"
        uses: docker/setup-qemu-action@v3
      -
        name: "Set up Docker Buildx ${{ matrix.arch }}"
        uses: docker/setup-buildx-action@v3
      -
        name: "Login to Docker Hub"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      -
        name: "Build and push ${{ matrix.arch }}"
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./build/dockerfiles/Dockerfile
          platforms: linux/${{ matrix.arch }}
          push: true
          provenance: false
          tags: ${{ env.IMAGE }}:${{ github.event.inputs.version }}-${{ matrix.arch }}
      -
        id: result
        name: "Build result outputs version"
        if: ${{ success() }}
        run: echo "${{ matrix.arch }}=${{ github.event.inputs.version }}-${{ matrix.arch }}" >> $GITHUB_OUTPUT

  create-manifest:
    needs: build-images
    runs-on: ubuntu-22.04
    steps:
      -
        name: "Login to Docker Hub"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      -
        name: "Create and push manifest"
        run: |
          AMD64_VERSION="${{ needs['build-images'].outputs.amd64 }}"
          ARM64_VERSION="${{ needs['build-images'].outputs.arm64 }}"

          if [[ -z "$AMD64_VERSION" || -z "$ARM64_VERSION" ]]; then
            echo "[!] The job 'build-images' fails on some of the architectures. Can't create complete manifest.";
            exit 1;
          fi

          AMEND=""
          AMEND+=" --amend ${{ env.IMAGE }}:$AMD64_VERSION";
          AMEND+=" --amend ${{ env.IMAGE }}:$ARM64_VERSION";

          docker manifest create ${{ env.IMAGE }}:${{ github.event.inputs.version }} $AMEND
          docker manifest push ${{ env.IMAGE }}:${{ github.event.inputs.version }}
      -
        id: result
        name: "Manifest result"
        if: ${{ success() }}
        run: |
          echo "[INFO] Manifest was created and pushed successfully"
          echo "[INFO] Released version: ${{ github.event.inputs.version }}"
          echo "[INFO] Image: ${{ env.IMAGE }}:${{ github.event.inputs.version }}"

  create-github-release:
    needs: create-manifest
    runs-on: ubuntu-22.04
    steps:
      -
        name: "Checkout Che Server Next source code"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}
      -
        name: "Create GitHub Release"
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Release ${{ github.event.inputs.version }}
          body: |
            ## Che Server Next ${{ github.event.inputs.version }}
            
            ### üê≥ Docker Image
            
            ```bash
            docker pull ${{ env.IMAGE }}:${{ github.event.inputs.version }}
            ```
            
            **Supported Architectures:**
            - linux/amd64
            - linux/arm64
            
            ### üì¶ Registry
            
            - **Docker Hub:** https://hub.docker.com/r/olexii4dockerid/che-server
            - **Image:** `${{ env.IMAGE }}:${{ github.event.inputs.version }}`
            
            ### üöÄ Deploy to Eclipse Che
            
            ```bash
            # Update cr-patch.yaml with the new version
            chectl server:update --che-operator-cr-patch-yaml=cr-patch.yaml
            ```
            
            ### üìù What's Changed
            
            See the [CHANGELOG](CHANGELOG.md) for detailed changes.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

