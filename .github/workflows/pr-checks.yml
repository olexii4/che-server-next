#
# Copyright (c) 2025 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#

name: PR

on:
  pull_request:
    branches: ['*']

env:
  IMAGE_VERSION: pr-${{ github.event.pull_request.number }}
  IMAGE: docker.io/olexii4dockerid/che-server

jobs:

  licenses:
    runs-on: ubuntu-22.04
    if: ${{ github.base_ref == 'main' }}
    steps:
      -
        name: "Checkout Eclipse Che Next source code"
        uses: actions/checkout@v4
      -
        name: "Use Node 20"
        uses: actions/setup-node@v4
        with:
          node-version: 20
      -
        name: "Enable Corepack for Yarn"
        run: corepack enable
      -
        name: "Install dependencies"
        run: yarn install --immutable
      -
        name: "Check dependencies usage restrictions"
        run: yarn license:check || echo "License check not configured yet"

  build-and-test:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    steps:
      -
        name: "Checkout Eclipse Che Next source code"
        uses: actions/checkout@v4
      -
        name: "Use Node.js ${{ matrix.node-version }}"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      -
        name: "Enable Corepack for Yarn"
        run: corepack enable
      -
        name: "Install dependencies"
        run: yarn install --immutable
      -
        name: "Build"
        run: yarn build
      -
        name: "Run linters"
        run: yarn lint:check
      -
        name: "Run unit tests"
        run: yarn test

  docker-build:
    needs: build-and-test
    runs-on: ubuntu-22.04
    continue-on-error: ${{ matrix.default == false }}
    strategy:
      fail-fast: false
      matrix:
        platform: [linux/amd64]
        default: [true]
        include:
          - platform: linux/arm64
            default: false
    outputs:
      amd64: ${{ steps.amd64.outputs.tag }}
      arm64: ${{ steps.arm64.outputs.tag }}
    steps:
      -
        name: "Checkout Eclipse Che Next source code"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      -
        name: "Set up QEMU"
        uses: docker/setup-qemu-action@v3
      -
        name: "Set up Docker Buildx ${{ matrix.platform }}"
        uses: docker/setup-buildx-action@v3
      -
        name: "Cache Docker layers"
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-
      -
        name: "Docker Hub Login"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      -
        name: "Set platform tag"
        id: platform_tag
        run: |
          PLATFORM=${{ matrix.platform }}
          ARCH=${PLATFORM#linux/}
          echo "ARCH=${ARCH}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ env.IMAGE }}:${{ env.IMAGE_VERSION }}-${ARCH}" >> $GITHUB_ENV
      -
        name: "Build and push ${{ matrix.platform }}"
        uses: docker/build-push-action@v5
        with:
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache
          context: .
          file: ./build/dockerfiles/Dockerfile
          platforms: ${{ matrix.platform }}
          push: true
          provenance: false
          tags: ${{ env.IMAGE_TAG }}
      -
        id: amd64
        name: "Output amd64 tag"
        if: ${{ matrix.platform == 'linux/amd64' }}
        run: echo "tag=${{ env.IMAGE_VERSION }}-amd64" >> $GITHUB_OUTPUT
      -
        id: arm64
        name: "Output arm64 tag"
        if: ${{ matrix.platform == 'linux/arm64' }}
        run: echo "tag=${{ env.IMAGE_VERSION }}-arm64" >> $GITHUB_OUTPUT

  create-manifest:
    if: always()
    needs: docker-build
    runs-on: ubuntu-22.04
    steps:
      -
        name: "Docker Hub Login"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      -
        name: "Create and push manifest"
        run: |
          AMEND=""
          AMD64_TAG="${{ needs['docker-build'].outputs.amd64 }}"
          if [ -n "$AMD64_TAG" ]; then
            AMEND+=" --amend ${{ env.IMAGE }}:$AMD64_TAG";
          fi
          ARM64_TAG="${{ needs['docker-build'].outputs.arm64 }}"
          if [ -n "$ARM64_TAG" ]; then
            AMEND+=" --amend ${{ env.IMAGE }}:$ARM64_TAG";
          fi
          if [ -z "$AMEND" ]; then
            echo "[!] The job 'docker-build' didn't provide any outputs. Can't create the manifest list."
            exit 1;
          fi
          docker manifest create ${{ env.IMAGE }}:${{ env.IMAGE_VERSION }} $AMEND
          docker manifest push ${{ env.IMAGE }}:${{ env.IMAGE_VERSION }}
      -
        name: "Comment with image name"
        uses: actions/github-script@v7
        with:
          script: |
            const { issue: { number: issue_number }, repo: { owner, repo } } = context;
            const cheServerImage = "${{ env.IMAGE }}:${{ env.IMAGE_VERSION }}";
            const patchCommand = `kubectl patch -n eclipse-che "checluster/eclipse-che" --type=json -p='[{"op": "replace", "path": "/spec/components/cheServer/deployment", "value": {containers: [{image: "${cheServerImage}", name: che-server}]}}]'`;
            const text = `
            üê≥ **Docker image build succeeded!**

            **Multiarch image:** \`${cheServerImage}\`
            - ‚úÖ linux/amd64
            - ‚úÖ linux/arm64

            <details>
            <summary>kubectl patch command</summary>

            \`\`\`bash
            ${patchCommand}
            \`\`\`

            </details>

            <details>
            <summary>Pull and run locally</summary>

            \`\`\`bash
            # Pull the image
            docker pull ${cheServerImage}

            # Run the server
            docker run -p 8080:8080 ${cheServerImage}
            \`\`\`

            </details>
            `;
            github.rest.issues.createComment({ issue_number, owner, repo, body: text });

